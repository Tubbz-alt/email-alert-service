#!/usr/bin/env ruby

require_relative "../email_alert_service/environment"
rabbitmq_options = EmailAlertService.config.rabbitmq
logger = EmailAlertService.config.logger

connection = AMQPConnection.new(rabbitmq_options)
connection.start

queue_binding = MajorChangeQueue.new(connection).bind

message_processor = MessageProcessor.new(connection.channel, logger)

listener = Listener.new(queue_binding, message_processor)

logger.info "Bound to exchange #{connection.exchange_name} on queue #{connection.queue_name}, listening for major changes"

at_exit do
  logger.info "Shutting down.."
  connection.stop
end

begin
  listener.listen
rescue SignalException => e
  logger.info "Received #{e}: exiting"
rescue Exception => e # rubocop:disable Lint/RescueException
  GovukError.notify(e)
  raise e
end
