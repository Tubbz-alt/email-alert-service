#!/usr/bin/env ruby

require 'byebug'

require 'pathname'
APP_ROOT = Pathname.new(File.expand_path(File.join(File.dirname(__FILE__), '..')))
$LOAD_PATH << APP_ROOT.to_s

environment = ENV['ENVIRONMENT'] || 'development'

require 'logger'
logfile = File.open(APP_ROOT+"log/#{environment}.log", 'a')
LOGGER = Logger.new(logfile, 'daily')
LOGGER.level = Logger::DEBUG
logfile.sync = true
$stderr = $stdout = logfile

require 'yaml'
RABBITMQ_OPTIONS = YAML.load(File.open(APP_ROOT+'config/rabbitmq.yml')).fetch(environment).freeze

require 'app/listeners/major_change_listener'
listener = MajorChangeListener.new(RABBITMQ_OPTIONS)

at_exit do
  puts "Shutting down.."
  listener.stop
end

listener.run
